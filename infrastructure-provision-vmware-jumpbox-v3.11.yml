---
- hosts: all
  tasks:
  - name: Add EPEL repository for CentOS deployments
    yum_repository:
      name: epel
      description: EPEL YUM repo
      baseurl: https://download.fedoraproject.org/pub/epel/$releasever/$basearch/
    when:
      - ansible_distribution == "CentOS"
  - name: Importing rpm gpg-key for CentOS deployments.
    shell: |
       rpm --import http://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-7 >> /tmp/epelgpgimport.log
    when:
      - ansible_distribution == "CentOS"
  - name: Register as auto-subscribe to red hat subscription.
    redhat_subscription:
      state: present
      username: "{{ rhel_username }}"
      password: "{{ rhel_password }}"
      auto_attach: true
    when:
      - ansible_distribution == "RedHat"
  - name: Enable a Ansible 2.6 repository
    rhsm_repository:
      name: rhel-7-server-ansible-2.6-rpms
      state: enabled
    when:
      - ansible_distribution == "RedHat"
  - name: Enable a OpenShift 3.11 repository
    rhsm_repository:
      name: rhel-7-server-ose-3.11-rpms
      state: enabled
    when:
      - ansible_distribution == "RedHat"
  - name: Enable rhel-7-server-rpms repository
    rhsm_repository:
      name: rhel-7-server-rpms
    when:
      - ansible_distribution == "RedHat"
  - name: Enable rhel-7-server-extras-rpms repository
    rhsm_repository:
      name: rhel-7-server-extras-rpms
      state: enabled
    when:
      - ansible_distribution == "RedHat"
  - name: Enable rhel-7-server-optional-rpms repository
    rhsm_repository:
      name: rhel-7-server-optional-rpms
      state: enabled
    when:
      - ansible_distribution == "RedHat"
  - name: Add Docker repo
    get_url:
      url: https://download.docker.com/linux/centos/docker-ce.repo
      dest: /etc/yum.repos.d/docker-ce.repo
    when:
      - ansible_distribution == "CentOS"
  - name: upgrade all packages
    yum:
      name: '*'
      state: latest
  - name: install base packages
    yum:
      name:
      - wget
      - git
      - net-tools
      - bind-utils
      - yum-utils
      - iptables-services
      - bridge-utils
      - bash-completion
      - kexec-tools
      - sos
      - psacct
      - vim
      state: present
  - name: install required packages for CENTOS
    yum:
      name:
        - pyOpenSSL
        - device-mapper-event-libs
        - device-mapper-libs
        - httpd-tools
        - java-1.8.0-openjdk-devel.x86_64
        - tmux
        - patch
        - lvm2
        - docker-ce
        - python-pip
      state: present
    when:
      - ansible_distribution == "CentOS"
  - name: Run script to modifiy terminal layout
    shell: |
         pip install passlib
    when:
      - ansible_distribution == "CentOS"
  - name: Download ansible-2.6.5 rpm for centos
    get_url:
      url: https://releases.ansible.com/ansible/rpm/release/epel-7-x86_64/ansible-2.6.5-1.el7.ans.noarch.rpm
      dest: /tmp/ansible-2.6.5-1.el7.ans.noarch.rpm
    when:
      - ansible_distribution == "CentOS"
  - name: Installing ansible-2.6.5-1.el7.ans.noarch.rpm on CentOS.
    shell: |
      yum install /tmp/ansible-2.6.5-1.el7.ans.noarch.rpm -y >> /tmp/ansibleinstall.log
    when:
      - ansible_distribution == "CentOS"
  - name: Install a list of packages
    yum:
      name:
        - ansible
        - docker
        - httpd-tools
        - java-1.8.0-openjdk-devel.x86_64
        - tmux
      state: present
    when:
      - ansible_distribution == "RedHat"
  - name: check if /etc/sysconfig/network-scripts/ifcfg-ens192 file exists
    stat: 
      path: /etc/sysconfig/network-scripts/ifcfg-ens192
    register: ifcfgens192
  - name: Turn off PEERDNS
    lineinfile:
      path:  /etc/sysconfig/network-scripts/ifcfg-ens192
      regexp: '^PEERDNS=yes'
      line: 'PEERDNS=no'
    when: 
      - ifcfgens192.stat.exists == true
  - name: Add loopback address as default DNS server
    lineinfile:
      path: /etc/sysconfig/network-scripts/ifcfg-ens192
      line: 'DNS1={{ dns_server_ip }}'
    when:
      - ifcfgens192.stat.exists == true
  - name: installing openshift-ansible RPM-based installer 
    yum:
      name:
      - openshift-ansible
  - name: Cloning  Bash full of Colors to machine
    git:
      repo: 'https://github.com/tosin2013/bash-full-of-colors.git'
      dest: /home/{{ rhel_user }}/bash-full-of-colors